<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVELTE plotly.js  | Flying Monocopter</title>
  <meta name="description" content="Flying Monocopter 'SVELTE plotly.js'을 한 번 살펴보세요.">
  <meta property="og:title" content="SVELTE plotly.js">
  
  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2020-11-24">
  
  <meta property="og:description" content="Flying Monocopter 'SVELTE plotly.js'을 한 번 살펴보세요.">
  <meta property="og:url" content="https://flyingmonocopter.github.io/posts/svelteplotly/">
  <meta property="og:site_name" content="Flying Monocopter">
  
  <meta property="og:image" content="https://flyingmonocopter.github.io/images/thumbnail.png">
  
  
  <meta property="og:tags" content="svelte">
  
  <meta property="og:tags" content="react">
  
  <meta property="og:tags" content="javascript">
  
  <meta property="og:tags" content="리액트">
  
  <meta property="og:tags" content="자바스크립트">
  
  <meta property="og:tags" content="plotly">
  
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="canonical" href="https://flyingmonocopter.github.io/posts/svelteplotly/">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/agate.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+KR&display=swap">
  <link rel="stylesheet" href="/css/styles.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-180510293-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-180510293-1');
  </script>
  
  
  <script type="text/javascript">
  function toggle_visibility(id) {
    var e = document.getElementById(id);
    if (e.className === 'menu')
      e.className = 'menu hidden';
    else
      e.className = 'menu';
  }
  </script>
</head>
<body>
  <div class="navbar">
    <div class="logo burger">
      <a href="/">
        <img src="/images/logo.png" height="34px" />
      </a>
    </div>
    <div class="burger">
      <button onclick="toggle_visibility('menu')">
        <i class="fa fa-bars" aria-hidden="true"></i>
      </button>
    </div>
    <div id="menu" class="menu hidden">
      <ul>
        <li><a href="/posts">POSTS...</a></li>
        <li><a href="/categories">@CATEGORIES</a></li>
        <li><a href="/tags">#TAGS</a></li>
        <li><a href="/about">{ABOUT}</a></li>
      </ul>
      <input class="search" id="search-input" type="search" placeholder="검색어" value="">
    </div>
  </div>


<div class="post">
  <div class="post-title">
    <a href="https://flyingmonocopter.github.io/posts/svelteplotly/">
      <img src="/images/post-title-icon.png" />
      <div class="post-meta">
        <time>
          
          2020년 11월 24일 21시 11분
          
        </time>
        <h1>SVELTE plotly.js</h1>
      </div>
    </a>
  </div>
  
  <div class="post-toc">
    <span class="title">차례</span>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#첫-발을-내-딛기">첫 발을 내 딛기</a>
      <ul>
        <li><a href="#vue-plotly">Vue Plotly</a></li>
        <li><a href="#프로젝트-생성부터">프로젝트 생성부터</a></li>
        <li><a href="#packagejson">Package.json</a></li>
        <li><a href="#다시-만난-this">다시 만난 this</a></li>
        <li><a href="#use-strict">use strict</a></li>
        <li><a href="#rollupconfigjs-수정">rollup.config.js 수정</a></li>
      </ul>
    </li>
    <li><a href="#plotlysvelte-만들기">Plotly.svelte 만들기</a>
      <ul>
        <li><a href="#plotlyjs-동작-이해">plotly.js 동작 이해</a></li>
        <li><a href="#wrapper-구현">Wrapper 구현</a></li>
      </ul>
    </li>
    <li><a href="#결론">결론</a></li>
  </ul>
</nav>
  </div>
  
  <section class="post-content">
    <p>지난번에 SVELTE plotly.js 가 없어서 프로젝트 마이그레이션이 지연되었다.</p>
<blockquote>
<p>그래서 SVELTE 를 조금만 더 파 보기로 했다.</p>
</blockquote>
<p>SVELTE 로 개발 프로젝트를 하는 것은 없어서, 이미 만들어놓은 React PID controller 를 SVELTE 로 바꿔보기로 했다.
제어 로직은 이미 클래스로 분리해 놓았기 때문에 UI 부분만 마이그레이션 하면 되었다.</p>
<p>그래프를 그리는데 plotly.js 와 react-plotly.js 를 사용했는데, 이 부분을 SVELTE 에 맞춰보는 것이 가장 필요했던 작업이었다.
react-plotly.js 는 plotly.js react 인터페이스로 포장한 wrapper 패키지이다.
SVELTE 에서도 마찬가지로 wrapper 패키지가 있으려니 했지만 찾지 못했다. 하나 만들어 보자.</p>
<h2 id="첫-발을-내-딛기">첫 발을 내 딛기</h2>
<h3 id="vue-plotly">Vue Plotly</h3>
<p>문법적으로 볼 때, SVELTE 는 react 보다 vue 에 가깝다.
Vue 에서는 이미 만들어 놓은 plotly.js wrapper 가 있는데, 이것들을 참고하기로 했다.
github.com:statnett/vue-plotly.git 이 가장 간단(?)해 보였다.</p>
<p>&ldquo;vue 도 배워야 하나&rdquo; 하는 자괴감이 들었지만,
기본적으로 Vue 를 조금 알아야 하기 때문에&hellip;
몇 시간 뒤적뒤적 Vue 에 대해 필요한만큼 학습</p>
<p>Vue 하위 컴포넌트로 prop 넘기는 방법을 이해하고, Plot 그래프를 그리기도 OK.
버튼 클릭하면 데이터를 업데이트되고 그래프가 자동적으로 바뀐다.</p>
<figure>
    <img src="/images/posts/vue-plot.png"
         alt="vue plotly"/> 
</figure>

<p>Plotly.vue 파일을 보면</p>
<pre><code>    this.$watch('data', () =&gt; {
      this.internalLayout.datarevision++
      this.react()
    }, { deep: !this.watchShallow })
</code></pre><p>data 를 watch 하고 있다가 react 를 부르는구나&hellip; SVELTE 에서 $: 를 쓰면 되지 않을까?</p>
<p>svelte wrapper 에서 할 수 있는 일을 보면,</p>
<ul>
<li>plot 그리기</li>
<li>plot 에서 발생하는 이벤트 넘겨주기</li>
<li>이미지로 저장</li>
</ul>
<p>일단 Plot 그리기만 잘 하면 일단 충분할 것 같다. 목표가 정해졌다.</p>
<h3 id="프로젝트-생성부터">프로젝트 생성부터</h3>
<p>plotly-test-svelte 라는 SVELTE 프로젝트르 하나 만들어서, 위에서 한 것과 동일한 것을 만들어 보려고 한다.</p>
<pre><code>$ npx degit sveltejs/template plotly-test-svelte
$ cd plotly-test-svelte
$ yarn
$ yarn add plotly.js
$ yarn dev
</code></pre><p>HELLO WORLD! 가 잘 뜬다.</p>
<p>plotly.js wrapper 인 Plotly.svelte 를 만들 것이다.</p>
<p>Wrapper 를 만들고,</p>
<pre><code>// vi src/Plotly.svelte
&lt;script&gt;
  import Plotly from 'plotly.js'
&lt;/script&gt;
</code></pre><p>App 에서 이를 가져다 쓸 것이다.</p>
<pre><code>// vi src/App.svelte
&lt;script&gt;
  import Plot from './Plotly.svelte';
  export let name;
&lt;/script&gt;
</code></pre><p>빌드가 좀 오래걸린다&hellip; 설마&hellip; 엄청난 에러가 떨어진다.</p>
<h3 id="packagejson">Package.json</h3>
<p>plotly.js 의 package.json 에는 main 과 webpack 두개의 속성이 보인다.</p>
<pre><code>$ vi node_modules/plotly.js/package.json
  ...
  &quot;main&quot;: &quot;./lib/index.js&quot;,
  &quot;webpack&quot;: &quot;./dist/plotly.js&quot;,
</code></pre><p>main 은 import 할때 default 시작 위치다. webpack 속성에 있는 소스로 바꿔 본다.
(dist 는 보통 컴파일 된 결과물을 베포하기 위한 공간이다)</p>
<pre><code>$ vi src/Plotly.svelte
&lt;script&gt;
  import Plotly from &quot;plotly.js/dist/plotly.js&quot;
&lt;/script&gt;
</code></pre><p>이제 빌드 에러는 사라졌다.</p>
<!-- raw HTML omitted -->
<p>이제 yarn dev 로 다시 실행시켜보는데, 브라우저에 아무것도 안나온다. 디버그 창을 열어보자.</p>
<pre><code>plotly.js:26368 Uncaught TypeError: Cannot read property 'document' of undefined
    at plotly.js:26368
    ...

변역: node_modules/plotly.js/dist/plotly.js 26368 라인에서 정의되지 않은 객체에서 document 속성을 읽으려고 한다.
</code></pre><p>소스를 보면 다음과 같다.</p>
<pre><code>  var d3_document = this.document;
</code></pre><p>plotly.js 는 내부적으로 d3 라이브러리를 이용한다는 사실을 알게 되었다.
아&hellip; this 가 undefined 구나. 어쩌라고???</p>
<h3 id="다시-만난-this">다시 만난 this</h3>
<p>피식 웃음이 나왔다. 바닐라 자바스크립트를 쓰는 것도 아닌데, 아직도 this 관련 에러가 나온다고&hellip;</p>
<p>메러 메시지는 구글신에게 물어본다.</p>
<blockquote>
<p>검색 : cannot read property &lsquo;document&rsquo; of undefined d3</p>
</blockquote>
<p>It sounds like something (Babel, most likely) is inserting &ldquo;use strict&rdquo;; at the beginning of the D3 script file or combining it into another file with &ldquo;use strict&rdquo; at the top. That means this at global scope (or in a function called without a specific this) is no longer a reference to the global object, it&rsquo;s undefined. (Whereas in &ldquo;loose&rdquo; mode or in a function called with no specific this value, this at global scope is a reference to the global object, which is also accessible via the global variable `window1.)</p>
<p>출처 : <a href="https://stackoverflow.com/questions/35560305/d3-js-uncaught-typeerror-cannot-read-property-document-of-undefined">https://stackoverflow.com/questions/35560305/d3-js-uncaught-typeerror-cannot-read-property-document-of-undefined</a></p>
<p>&ldquo;use strict&rdquo; 를 꺼야 한다는 이야기가 아닐까? 그런데 어떻게?</p>
<h3 id="use-strict">use strict</h3>
<p>잠깐이라도 어떤 문제인지 이해해보자.</p>
<p>아래 html 을 브라우저에서 읽으면, 1, 2, 3 모두 window 객체를 리턴한다.
첫번째 &ldquo;use strict&rdquo; 주석을 해재하면, 2, 3 은 undefined 가 뜬다.
이것이 global scope is no longer a reference&hellip; 뜻인가 보다.</p>
<pre><code>&lt;script&gt;
  console.log(&quot;1&quot;, this)

  var app = (function () {
    // &quot;use strict&quot;
    console.log(&quot;2&quot;, this);
    !function() {
      // &quot;use strict&quot;
      console.log(&quot;3&quot;, this);
    }()
  }())
&lt;/script&gt;

&lt;h1&gt; Loot at this &lt;/h1&gt;
</code></pre><p>바로 1번 위치에서 &ldquo;use strict&rdquo; 를 넣으면 this.document 에서 this 가 undefined 가 되는 것이다.</p>
<!-- raw HTML omitted -->
<h3 id="rollupconfigjs-수정">rollup.config.js 수정</h3>
<p>rollup 다음 문서를 참고한다.
<a href="https://rollupjs.org/guide/en/#outputstrict">https://rollupjs.org/guide/en/#outputstrict</a></p>
<p>output 옵션에 strict: false 를 추가한다.</p>
<pre><code>export default {
	input: 'src/main.js',
	output: {
		sourcemap: true,
		format: 'iife',
		strict: false,
		name: 'app',
		file: 'public/build/bundle.js'
	},
</code></pre><p>이제 d3 관련 에러도 사라졌다.</p>
<!-- raw HTML omitted -->
<p>SVELTE 공식 지원 번들러는 rollup 과 webpack 이 있다.
webpack 을 쓰려면, 프로젝트 template 를 바꿔야 한다.</p>
<pre><code>$ npx degit sveltejs/template-webpack plotly-test-webpack
</code></pre><p>이 경우는 use strict 문제가 생기지 않는다.</p>
<!-- raw HTML omitted -->
<h2 id="plotlysvelte-만들기">Plotly.svelte 만들기</h2>
<p>구현은 의외로 간단하다.</p>
<h3 id="plotlyjs-동작-이해">plotly.js 동작 이해</h3>
<ul>
<li>Plotly.js 에서 그래프를 그리려면 data, layout, config 세가지 파라미터가 필요하다.</li>
<li>Plotly.svelte 는 이 파라미터를 받아서 이를 파라미터로 Plotly.js 의 함수를 호출하는 구조로 되어있다.</li>
<li>Plotly.newPlot 으로 그래프를 새로 그리고, data 가 바뀌어 그래프를 업데이트 할 때는 Plotly.react 를 호출하는 것 같다.</li>
<li>App.js 에서 이 세가지를 plotly.js 가 원하는 형태로 넘겨주면 된다.</li>
</ul>
<p>plotly.js 는 매우 큰 라이브러리이다. 하지만 우리는 그래프를 그리기만 할 것이므로 plotly.js 분석은 여기까지 하도록 한다.</p>
<h3 id="wrapper-구현">Wrapper 구현</h3>
<ul>
<li>export let 으로 property 3개를 받는다.</li>
<li>컴포넌트가 mount 될 때 그래프를 그릴 영역을 얻어와서 그래프를 그린다.</li>
<li>data 가 업데이트 되면 $: reativity 가 자동적으로 호출된다.</li>
<li>일단 그래프 그래는 기능만 갖고 있다. Plotly.js 로부터 발생되는 이벤트 처리나,이미지 저장 같은 작업은 당장 필요하지 않다.</li>
</ul>
<pre><code>// vi src/Plotly.svelte
&lt;script&gt;
  import Plotly from 'plotly.js/dist/plotly';
  import { onMount } from 'svelte';

  export let data;
  export let layout;
  export let config;

  let div_for_plot = undefined
  let Plot = undefined

  onMount(() =&gt; {
    div_for_plot = document.getElementById('plot_svelte');
    Plot = new Plotly.newPlot(div_for_plot, data, layout, config);
  });

  $: if (Plot) Plotly.react(div_for_plot, data, layout, config);

&lt;/script&gt;

&lt;div id=&quot;plot_svelte&quot; /&gt;

</code></pre><h2 id="결론">결론</h2>
<p>제주도 한달 살기처럼 SVELTE 일주일만 더 써보기로 했는데 좀 더 오랫동안 SVLTE 를 가지고 다뤄봤다.</p>
<p>import 문제, use strict 문제 등은 레거시 코드를 다루는데 있어서 많이 발생하는 문제였는데,
this 를 만나게 될 줄은 몰랐다.</p>
<p>다음에는 빌드 성능, rollup 과 webpack 차이, 배포시 문제 등을 알아보도록 하겠다.</p>
<!-- raw HTML omitted -->

  </section>


  <div class="post-meta-code">
  
    <div>
      <i>관련 글 : </i>
      
      
      <a class="left" href="https://flyingmonocopter.github.io/posts/sveltefromreact/" rel="prev">
        이전글 : <span>SVELTE from React</span>
      </a>
      
      
      
      
      <a class="right" href="https://flyingmonocopter.github.io/posts/sveltepidcontrol/" rel="next">
        다음글 : <span>SVELTE 버전 PID controller</span>
      </a>
      
      
    </div>
  

  
    <div>
      <i>카테고리 : </i>
      
      
      <a href="https://flyingmonocopter.github.io//categories/programming">[programming]</a>
      
    </div>
  

  
    <div>
      <i>태그 : </i>
      
      
      <a href="https://flyingmonocopter.github.io/tags/svelte">#svelte</a>
      
      <a href="https://flyingmonocopter.github.io/tags/react">#react</a>
      
      <a href="https://flyingmonocopter.github.io/tags/javascript">#javascript</a>
      
      <a href="https://flyingmonocopter.github.io/tags/%EB%A6%AC%EC%95%A1%ED%8A%B8">#리액트</a>
      
      <a href="https://flyingmonocopter.github.io/tags/%EC%9E%90%EB%B0%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8">#자바스크립트</a>
      
      <a href="https://flyingmonocopter.github.io/tags/plotly">#plotly</a>
      
      
    </div>
  

  
    <div>
      <i>참고 글 : </i>
      
      <a href="https://stackoverflow.com/questions/35560305/d3-js-uncaught-typeerror-cannot-read-property-document-of-undefined">https://stackoverflow.com/questions/35560305/d3-js-uncaught-typeerror-cannot-read-property-document-of-undefined</a>
      
      <a href="https://rollupjs.org/guide/en/#outputstrict">https://rollupjs.org/guide/en/#outputstrict</a>
      
    </div>
  

  </div>




  <div class="post-comment">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "flying-monocopter" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>



</div>


<footer class="footer">
  <div class="copyright">
    <a href="https://gohugo.io/"><img src="/images/hugo-logo-wide.svg" height=20px></a>
  </div>
  <div class="copyright">
    HUGO THEME by COPYRIGHT (C) <a href="https://blog.lulab.net">DONGGEUN,BANG (LUBANG).</a> ALL RIGHTS RESERVED.
  </div>
  <div class="share">
    FLYING MONOCOPTER :
    <a href="https://github.com/doojinkang" title="Github" target="_blank"><i class="fa fa-github"></i> GITHUB </a> &nbsp;
    <a href="mailto:doojin.kang@gmail.com" title="Email" target="_blank"><i class="fa fa-envelope"></i> mail</a>
  </div>
</footer>
</body>
</html>

